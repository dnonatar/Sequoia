<!DOCTYPE html>
<html>

<head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src='https://raw.githack.com/karpathy/tsnejs/master/tsne.js'></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<style>
            /* tell the SVG path to be a thin blue line without any area fill */
				path { 
						stroke-width: 1; fill: none; 
				} 
				.line_hover { 
						stroke: blue; stroke-width: 3;
				} 
				.line_click {
            stroke: black; 
				}
				.line_brush {
            stroke: black;
						opacity : 0.5;
				}  
				.axis { 
						shape-rendering: crispEdges; 
				} 
				.x.axis line {
            stroke: lightgrey; 
				} .x.axis 
				.minor { stroke-opacity: .5; 
				} 
				.x.axis path
            { display: none; 
				} 
				.x.axis text { font-size: 14; 
				} 
				.y.axis line, .y.axis
            path { fill: none; stroke: #000; } .y.axis text { font-size: 14; } .y.axisRight
            text { fill: orange; } .y.axisLeft text { fill: steelblue; } 
				
				.button {
            position: absolute;
            top: 15px;
            left: 30px;
         }
				.text-input {
	            position: absolute;
	            top: 15px;
	            left: 300px;
	      }
				.viewport {
            position: absolute;
            top: 45px;
            left: 15px;
            overflow: auto;
            width: 360px;
            height: 450px;
            background-color: #e8e8e8;
            border: 1px solid #AAAAAA;
            border-radius: 4px;
            box-shadow: inset 1px 1px 6px 2px rgba(0,0,0, .25);
        }
				
				.viewport_selected {
            position: absolute;
            top: 530px;
            left: 15px;
            overflow: auto;
            width: 360px;
            height: 120px;
            background-color: #e8e8e8;
            border: 1px solid #AAAAAA;
            border-radius: 4px;
            box-shadow: inset 1px 1px 6px 2px rgba(0,0,0, .25);
        }
				.viewport_selected_text {
						position: absolute;
						top: 490px;
            left: 15px;
				}
				.tsne {
            position: absolute;
            top: 250px;
            left: 450px;
            
        }
				.raw_signal {
            position: absolute;
            top: -30px;
            left: 400px;
            width: 350px;
            height: 300px;
        }
				div.tooltip {	
    				position: absolute;			
    				text-align: center;			
    				width: 100px;					
    				height: 48px;					
    				padding: 2px;				
    				font: 12px sans-serif;		
    				background: lightsteelblue;	
    				border: 0px;		
   				 	border-radius: 8px;			
    				pointer-events: none;			
				}
				.brushed {
            opacity: 1.0;
        }
        .non_brushed {
            opacity: 0.7;
        }
				.read_ID {
    				position: absolute;			
						top: 250px;
            left: 1000px;
						width: 300px;					
    				height: 350px;
						overflow: scroll;						
				}
				.clear_readID {
						position: absolute;			
						top: 620px;
            left: 1000px;
				}
					
</style>
</head>

<body>
<div class = "button">
	<form id="sort">
	<div> Sort by
		<input type='radio' id="kmer" name="mode" checked>kmer</input> 
		<input  type='radio' id="median" name="mode">median</input>
		<input  type='radio' id="max" name="mode">max</input>
  </div>
	</form>
</div>

<div class = "text-input">
		<form name="myform" onkeyup="return handleType()">
	    <input type="text" id="myVal1" placeholder="Partial or Full Kmer">
		</form>
	</div>

<div class = "viewport"></div>
<div class = "viewport_selected_text">
	<p><b>Selected Kmers</b></p>
</div>
<div class = "viewport_selected"></div>
<div class = "tsne">
<!--<svg width="500" height="500">
  <rect width="400" height="400" style="fill:none;stroke-width:1;stroke:rgb(0,0,0)" />
</svg>-->
</div>
<div class = "raw_signal"></div>
<div class = "read_ID"></div>
<div class = "clear_readID">
	<button type ="button" onclick= "clear_ID()"> Clear Read ID</button>
</div>
<script type="text/javascript">
var box_colors = ["rgb(51, 160, 44)","rgb(31, 120, 180)","rgb(178, 223, 138)","rgb(166, 206, 227)"]
var tsne_colors = []
function clear_ID() {
	d3.select(".read_ID").selectAll('*').remove()
}
function handleType(event){
	//kmer_list = []
	console.log(kmer_list)
	//d3.select('#tsne').selectAll('circle').remove()
	//d3.selectAll('.line_click').remove()
	text = document.getElementById("myVal1").value
	if (text.length == 0) {
		text = '*****'
	} else if (text.length == 1) {
		text = text + '****'
	} else if (text.length == 2) {
		text = text + '***'
	}	else if (text.length == 3) {
		text = text + '**'
	} else if (text.length == 4) {
		text = text + '*'
	}
	d3.csv('./data/boxplot_data.csv', function(data) {
		var kmerValues = data.map(d => d['kmer'])
		
		function matching(kmer) {
			exact1 = kmer[0] == text[0]
			exact2 = kmer[1] == text[1]
			exact3 = kmer[2] == text[2]
			exact4 = kmer[3] == text[3]
			exact5 = kmer[4] == text[4]
			var exact = [exact1,exact2,exact3,exact4,exact5] 
			
			any1 = kmer[0] == 'A' || kmer[0] == 'T' || kmer[0] == 'G' || kmer[0] == 'C' 
			any2 = kmer[1] == 'A' || kmer[1] == 'T' || kmer[1] == 'G' || kmer[1] == 'C' 
			any3 = kmer[2] == 'A' || kmer[2] == 'T' || kmer[2] == 'G' || kmer[2] == 'C' 
			any4 = kmer[3] == 'A' || kmer[3] == 'T' || kmer[3] == 'G' || kmer[3] == 'C' 
			any5 = kmer[4] == 'A' || kmer[4] == 'T' || kmer[4] == 'G' || kmer[4] == 'C' 
			
			var any = [any1,any2,any3,any4,any5]
 
			var conditions = []
			for (i=0;i<5;i++) {
				if (text[i]=='*') {
					conditions.push(any[i])
				} else {
					conditions.push(exact[i])
				}
			}
			return (conditions[0] && conditions[1] && conditions[2] && conditions[3] && conditions[4])
		}
		filtered_kmers = kmerValues.filter(matching)
		
    // exclude selected kmered from viewport after typeing
		for (i=0;i<kmer_list.length;i++){
			index = filtered_kmers.indexOf(kmer_list[i])
			filtered_kmers.splice(index, 1)
			console.log(index)
		}
		filtered_data = []
		for (i=0;i<256;i++) {
			if(filtered_kmers.includes(data[i]['kmer']) ){
				filtered_data.push(data[i])
			}
		}
		var form = document.getElementById("sort")
			var form_val;
			for(var i=0; i<form.length; i++){
      	  if(form[i].checked){
      	    form_val = form[i].id;}} 
		d3.select(".viewport").selectAll("*").remove()
		draw_boxplot(filtered_data, form_val)
	})
	
	// return false prevents the page from reloading after submitting		
	return false;
}
	
var opt = {epsilon: 10}; // epsilon is learning rate (10 = default)
var tsne = new tsnejs.tSNE(opt); // create a tSNE instance
// draw t-sne
function draw_tsne(position, kmer_list) {
		
		var width = 500;
		var height = 400;
		var padding = 65;
		
		d3.select('#tsne').remove()
		var svg = d3.select('.tsne')
				.append('svg')
				.attr("width", width)
        .attr("height", height)
				.attr("id", "tsne")		
		var xScale = d3.scaleLinear()
				.domain(d3.extent(position, function(d) {return d[0];	}))	
				.range([padding,width - padding * 2])
				.nice();
		var yScale = d3.scaleLinear()
				.domain(d3.extent(position, function(d) {return d[1]; }))
				.range([height - padding, padding])
				.nice();  
		var brush = d3.brush()
									//.extent([[0, 0], [100, 100]])
									//.on("brush", highlightBrushedCircles)
									//.on("end", endBrush)
									.on("brush", whileBrush)
		d3.select('#tsne').append("g")
				.call(brush)
				.call(brush.move)
		d3.select('#tsne').append('g')
        .append('rect')
        .attr('class', 'tsne_edges')
        .attr('x', 0)
        .attr('y', 0)
        .attr('height', height)
        .attr('width', width)
        .style('fill', 'none')
        .style('stroke', 'black')
        .style('stroke-width', '1px')
				.style('opacity', 1)
		var circles = svg.append("g")
				.selectAll('circle')
			  .data(position)
			  .enter()
			  .append('circle')
				.attr('x', function(d) {
						return xScale(d[0]);
				})	
				.attr('y', function(d) {
						return yScale(d[1]);
				})
				.attr('r', 6)
				.attr('cx', function(d) {
						return xScale(d[0]);
				})
				.attr('cy', function(d) {
						return yScale(d[1]);
				})
				.attr("class", "non_brushed")
				.style('fill', function(d,i) { 
											if (kmer_list.length == 1) {
												return tsne_colors[0];
											
											} else if (kmer_list.length == 2) {	
												if (i < position.length/2) {
													return tsne_colors[0];
												} else {
													return tsne_colors[1];
												}
											} else if (kmer_list.length == 3) {
												if (i < position.length/3) {
													return tsne_colors[0];
												} else if(i >= position.length/3 && i < 2*position.length/3) {
													return tsne_colors[1];
												} else {
													return tsne_colors[2];
												}
											} else if (kmer_list.length == 4) {
													if (i < position.length/4) {
													return tsne_colors[0];
												} else if(i >= position.length/4 && i < 2*position.length/4) {
													return tsne_colors[1];
												} else if(i >= 2*position.length/4 && i < 3*position.length/4) {
													return tsne_colors[2];
												} else {
													return tsne_colors[3];
												}
											}
				})
				.on('click',function(d,i){
												if (d3.select(this).attr("r") == "6") { 
													d3.select(this).attr("r", "8");
												}	else {
													d3.select(this).attr("r", "6");
												}
												
												add_signal(i, kmer_list);
												
				})
				
				.on('mouseover', function(d,i){
 												d3.select(this).attr("r", "10");
												add_signal_hover(i, kmer_list);
				})
				.on('mouseout', function(d,i){
												d3.select(this).attr("r", "6");
												remove_signal_hover();
				})
				.on('dblclick', function(d, i) {
						printReadID(kmer_list, i)
				})
		
		function highlightBrushedCircles() {
        if (d3.event.selection != null) {
           // revert circles to initial style
           circles.attr("class", "non_brushed");
           var brush_coords = d3.brushSelection(this);
           // style brushed circles
           circles.filter(function (){
           						var cx = d3.select(this).attr("cx"),
                          cy = d3.select(this).attr("cy");
                      return isBrushed(brush_coords, cx, cy);
                  })
                  .attr("class", "brushed");
					
         }
		}
		function whileBrush() {
				// disregard brushes w/o selections
				if (!d3.event.selection) return;
				// programmed clearing of brush after mouse-up
				//d3.select(this).call(brush.move, null);
				
				if (d3.event.selection != null) {
           // revert circles to initial style
           circles.attr("class", "non_brushed");
           var brush_coords = d3.brushSelection(this);
           // style brushed circles
           circles.filter(function (){
           						var cx = d3.select(this).attr("cx"),
                          cy = d3.select(this).attr("cy");
                      return isBrushed(brush_coords, cx, cy);
                  })
                  .attr("class", "brushed");
					
         }
				//get indices for the brushed points
        var d_brushed =  d3.selectAll(".brushed").data();			
				var row_list = []				
				if (d_brushed.length > 0 && row_list.length ==0) {
            d_brushed.forEach(d_each => row_list.push(position.indexOf(d_each)))
				} 
				add_signal_brush(row_list, kmer_list)
		}		
}
function printReadID(kmer_list, row) {
		if (kmer_list.length == 1) {
			kmer1 = kmer_list[0]
			filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
			queue()
				.defer(d3.csv, filename1)
				.await(print_ID)
	
			function print_ID(error, file1){
					d = file1
					ID = d[row]['read_ID']
					d3.select(".read_ID").append("tspan")
								.text(function(d){return ID+"   "; })
												
					
			}	
		} else if (kmer_list.length == 2) {
			kmer1 = kmer_list[0]
			kmer2 = kmer_list[1]
			filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
			filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
	
			queue()
				.defer(d3.csv, filename1)
				.defer(d3.csv, filename2)
				.await(print_ID)
		
			function print_ID(error, file1, file2){
					d = file1.concat(file2)
					ID = d[row]['read_ID']
					d3.select(".read_ID").append("tspan")
								.text(function(d){return ID+"   "; })
					
			}
		}	else if (kmer_list.length == 3) {
			kmer1 = kmer_list[0]
			kmer2 = kmer_list[1]
			kmer3 = kmer_list[2]
			filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
			filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
			filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
	
			queue()
				.defer(d3.csv, filename1)
				.defer(d3.csv, filename2)
				.defer(d3.csv, filename3)
				.await(print_ID)
		
			function print_ID(error, file1, file2, file3){
					d = file1.concat(file2).concat(file3)
					ID = d[row]['read_ID']
					d3.select(".read_ID").append("tspan")
								.text(function(d){return ID+"   "; })	
			}
		}	else if (kmer_list.length == 4) {
			kmer1 = kmer_list[0]
			kmer2 = kmer_list[1]
			kmer3 = kmer_list[2]
			kmer4 = kmer_list[3]
			filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
			filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
			filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
			filename4 = './data/raw_signal/'+kmer4+'_signal.csv';
	
			queue()
				.defer(d3.csv, filename1)
				.defer(d3.csv, filename2)
				.defer(d3.csv, filename3)
				.defer(d3.csv, filename4)
				.await(print_ID)
		
			function print_ID(error, file1, file2, file3, file4){
					d = file1.concat(file2).concat(file3).concat(file4)
					ID = d[row]['read_ID']
					d3.select(".read_ID").append("tspan")
								.text(function(d){return ID+"   "; })
					
			}
		}		
					
}
function isBrushed(brush_coords, cx, cy) {
     var x0 = brush_coords[0][0],
         x1 = brush_coords[1][0],
         y0 = brush_coords[0][1],
         y1 = brush_coords[1][1];
	
      return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;
}
// add new signals to data array and then pass it to draw_signal 
var data_click = []
var data_hover = []
var data_row = []
var data_brush = []
function add_signal_brush(row_list, kmer_list) {
	if (kmer_list.length == 1) {
		kmer1 = kmer_list[0]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.await(add)
	
		function add(error, file1){
				d = file1
				if (data_brush.length >0){
						data_brush.length = 0
				}
				for (i=0;i<row_list.length;i++){
						row = row_list[i]
						data_brush.push(d[row]['values'].split("_").map(Number))
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	} else if (kmer_list.length == 2) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.await(add)
	
		function add(error, file1, file2){
				d = file1.concat(file2)
				if (data_brush.length >0){
						data_brush.length = 0
				}
				for (i=0;i<row_list.length;i++){
						row = row_list[i]
						data_brush.push(d[row]['values'].split("_").map(Number))
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	}	else if (kmer_list.length == 3) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.await(add)
	
		function add(error, file1, file2, file3){
				d = file1.concat(file2).concat(file3)
				if (data_brush.length >0){
						data_brush.length = 0
				}
				for (i=0;i<row_list.length;i++){
						row = row_list[i]
						data_brush.push(d[row]['values'].split("_").map(Number))
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	}	else if (kmer_list.length == 4) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		kmer4 = kmer_list[3]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		filename4 = './data/raw_signal/'+kmer4+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.defer(d3.csv, filename4)
			.await(add)
	
		function add(error, file1, file2, file3, file4){
				d = file1.concat(file2).concat(file3).concat(file4)
				if (data_brush.length >0){
						data_brush.length = 0
				}
				for (i=0;i<row_list.length;i++){
						row = row_list[i]
						data_brush.push(d[row]['values'].split("_").map(Number))
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	}	
}
function add_signal(row, kmer_list){
	if (kmer_list.length == 1) {
		kmer1 = kmer_list[0]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.await(add)
		function add(error, file1){
				d = file1
				if (data_row.includes(row)) {
						index = data_row.indexOf(row)
						data_row.splice(index, 1)
						data_click.splice(index, 1)
	
				} else {
						data_row.push(row)
						data_click.push(d[row]['values'].split("_").map(Number))		
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	} else if (kmer_list.length == 2) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.await(add)
		function add(error, file1, file2){
				d = file1.concat(file2)
				if (data_row.includes(row)) {
						index = data_row.indexOf(row)
						data_row.splice(index, 1)
						data_click.splice(index, 1)
	
				} else {
						data_row.push(row)
						data_click.push(d[row]['values'].split("_").map(Number))		
	
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	} else if (kmer_list.length == 3) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.await(add)
		function add(error, file1, file2, file3){
				d = file1.concat(file2).concat(file3)
				if (data_row.includes(row)) {
						index = data_row.indexOf(row)
						data_row.splice(index, 1)
						data_click.splice(index, 1)
	
				} else {
						data_row.push(row)
						data_click.push(d[row]['values'].split("_").map(Number))		
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	} else if (kmer_list.length == 4) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		kmer4 = kmer_list[3]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		filename4 = './data/raw_signal/'+kmer4+'_signal.csv';
		queue()
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.defer(d3.csv, filename4)
			.await(add)
		function add(error, file1, file2, file3, file4){
				d = file1.concat(file2).concat(file3).concat(file4)
				if (data_row.includes(row)) {
						index = data_row.indexOf(row)
						data_row.splice(index, 1)
						data_click.splice(index, 1)
	
				} else {
						data_row.push(row)
						data_click.push(d[row]['values'].split("_").map(Number))		
				}
				
				draw_signal(data_click, data_hover, data_brush)
		}
	}
}
var signalToAdd = null;
function add_signal_hover(row, kmer_list){
	if (kmer_list.length == 1) {
		kmer1 = kmer_list[0]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		queue()	
			.defer(d3.csv, filename1)
			.await(add)
		current_kmer = kmer1
		signalToAdd = current_kmer + '_' + row;
		function add(error, file1){
				d = file1
						d3.selectAll('.line_hover').remove();
						if (signalToAdd == current_kmer + '_' + row)
						{
							data_hover.push(d[row]['values'].split("_").map(Number))
							draw_signal(data_click, data_hover, data_brush)
							
						}
	
		}
	}	else if (kmer_list.length == 2) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		queue()	
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.await(add)
		current_kmer = kmer1+'_'+kmer2
		signalToAdd = current_kmer + '_' + row;
		function add(error, file1, file2){
				d = file1.concat(file2)
						d3.selectAll('.line_hover').remove();
						if (signalToAdd == current_kmer + '_' + row)
						{
							data_hover.push(d[row]['values'].split("_").map(Number))
							draw_signal(data_click, data_hover, data_brush)
						}
		}
	} else if (kmer_list.length == 3) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		queue()	
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.await(add)
		current_kmer = kmer1+'_'+kmer2+'_'+kmer3
		signalToAdd = current_kmer + '_' + row;
		function add(error, file1, file2, file3){
				d = file1.concat(file2).concat(file3)
						d3.selectAll('.line_hover').remove();
						if (signalToAdd == current_kmer + '_' + row)
						{
							data_hover.push(d[row]['values'].split("_").map(Number))
							draw_signal(data_click, data_hover, data_brush)
						}
		}
	} else if (kmer_list.length == 4) {
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		kmer4 = kmer_list[3]
		
		filename1 = './data/raw_signal/'+kmer1+'_signal.csv';
		filename2 = './data/raw_signal/'+kmer2+'_signal.csv';
		filename3 = './data/raw_signal/'+kmer3+'_signal.csv';
		filename4 = './data/raw_signal/'+kmer4+'_signal.csv';
		queue()	
			.defer(d3.csv, filename1)
			.defer(d3.csv, filename2)
			.defer(d3.csv, filename3)
			.defer(d3.csv, filename4)
			.await(add)
		current_kmer = kmer1+'_'+kmer2+'_'+kmer3+'_'+kmer4
		signalToAdd = current_kmer + '_' + row;
		function add(error, file1, file2, file3, file4){
				d = file1.concat(file2).concat(file3).concat(file4)
						d3.selectAll('.line_hover').remove();
						if (signalToAdd == current_kmer + '_' + row)
						{
							data_hover.push(d[row]['values'].split("_").map(Number))
							draw_signal(data_click, data_hover, data_brush)
						}
		}
	}
}
function remove_signal_hover(){
	
	data_hover = []
	d3.selectAll('.line_hover').remove();
	signalToAdd=null;
}
var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);
box_colors = ["rgb(51, 160, 44)","rgb(31, 120, 180)","rgb(178, 223, 138)","rgb(166, 206, 227)"]  //reset when changing sort type
d3.csv('./data/boxplot_data.csv', function(data) {
		
		function changeBoxplot(){
			d3.select('#tsne').selectAll('circle').remove()
			d3.select(".viewport").selectAll("*").remove()
			var form = document.getElementById("sort")
			var form_val;
			for(var i=0; i<form.length; i++){
      	  if(form[i].checked){
      	    form_val = form[i].id;}} 
			
			draw_boxplot(data, form_val)
		}
		var dataDim = d3.select("#sort")
		dataDim.on("change", changeBoxplot)
		draw_boxplot(data, 'kmer')
})
kmer_list = []
function draw_boxplot(data, form_val) {
		
		if (form_val == 'median') {
			data.forEach(function(data){ data['median']= +data['median'];});
			
				data.sort(function(a,b) {
    			return b[form_val] - a[form_val];
				});
		}	else if (form_val == 'kmer') {
			
			data.sort(function(a,b) {
    		var x = a[form_val].toLowerCase();
    		var y = b[form_val].toLowerCase();
    		return x < y ? -1 : x > y ? 1 : 0;
			});
		} else if (form_val == 'max') {
			data.forEach(function(data){ data['median']= +data['median'];});
			
				data.sort(function(a,b) {
    			return b[form_val] - a[form_val];
				});
		}
		
		var w = 350
		var h = 7500*data.length /256
		var margin = {
    top: 20,
    bottom: 20,
    left: 20,
    right: 30
  	}
	d3.select('.viewport')
    .append('svg')
    .attr('height', h)
    .attr('width', w)
	var catVariable = 'order'
	var catValues = data.map(d => Number(d[catVariable]))
	var kmerValues = data.map(d => d['kmer'])
	const minVariable = 'min'
  const maxVariable = 'max'
  const medianVariable = 'median'
  const q1Variable = 'q1'
  const q3Variable = 'q3'
	var xScale = d3.scaleLinear()
			.domain([0,8000])
			.range([margin.left, w- margin.right-50])
	/*var yScale = d3.scaleLinear()
			.domain([
				Number(d3.max(data, d => d[catVariable])) + 1,
				Number(d3.min(data, d => d[catVariable])) - 1
			])
			.range([h - margin.bottom, margin.top])	
  */
	
	var yScale = d3.scalePoint()
			.domain(kmerValues)
			.range([margin.top,h - margin.bottom])
	/*var xAxis = d3.axisBottom()
								.scale(xScale)
								.ticks(10)
								.tickSize(-470) 
				
	d3.select('svg')
		.append('g')
		.attr('transform', 'translate(0,480)')
		.attr('id', 'xAxisG')
		.call(xAxis) */
	var yAxis = d3.axisRight()
								.scale(yScale)
								.tickSize(-470)
    						//.tickValues(catValues)
								//.tickValues(kmerValues)
								
	
	d3.select('svg')
		.append('g')
		.attr('transform', 'translate(300,0)')
		.attr('id', 'yAxisG')
		.call(yAxis)
	d3.select('svg')
		.selectAll('g.box')
		.data(data)
		.enter()
		.append('g')
		.attr('class', 'box')
		.attr(
			'transform', d => `translate(${xScale(d[medianVariable])},${yScale(d['kmer'])})`
		)
		
		.each(function(d, i) {
			d3.select(this)
        .append('rect')
        .attr('class', 'cover')
        .attr('x', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y', -10)
        .attr('height', 20)
        .attr('width', 480)
        .style('fill', 'white')
        .style('stroke', 'black')
        .style('stroke-width', '1px')
				.style('opacity', 0)
				.on("click", function(d) {				
					
					if (d3.select(this).style("fill") ==	"white") {
							kmer_list.push(d.kmer)
							d3.select(this).style("opacity",0.3)
							d3.select(this).style("stroke",'none')
							d3.select(this).style("fill",box_colors[box_colors.length-1])
							tsne_colors.push(box_colors[box_colors.length-1])	
							box_colors.pop()
							
							// remove selected boxplot from the current viewport
							index = kmerValues.indexOf(d.kmer)
							kmerValues.splice(index, 1)
							filtered_data = []
							for (i=0;i<data.length;i++) {
								if(kmerValues.includes(data[i]['kmer']) ){
								filtered_data.push(data[i])
								}
							}
							var form = document.getElementById("sort")
							var form_val;
							for(var i=0; i<form.length; i++){
      	  			if(form[i].checked){
      	    			form_val = form[i].id;
								}
							} 
							d3.select(".viewport").selectAll("*").remove()
							draw_boxplot(filtered_data, form_val)						
							draw_clicked_boxplot(kmer_list, tsne_colors, kmerValues)
					} 
						if (kmer_list.length == 1) {
								combine_1_kmer(kmer_list)
						} else if (kmer_list.length == 2) {
								combine_2_kmers(kmer_list)
						} else if (kmer_list.length == 3) {
								combine_3_kmers(kmer_list)
						} else if (kmer_list.length == 4) {
								combine_4_kmers(kmer_list)
						} else{
								d3.select('#tsne').selectAll('circle').remove()
						}
			
        })
			d3.select(this)
				.append('line')
				.attr('class', 'range')
				.attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', 0)
        .attr('y2', 0)
        .style('stroke', 'black')
        .style('stroke-width', '3px')
			d3.select(this)
        .append('line')
        .attr('class', 'max')
        .attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')			
			d3.select(this)
				.append('line')
        .attr('class', 'min')
        .attr('x1', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')
			d3.select(this)
        .append('rect')
        .attr('class', 'range')
        .attr('x', xScale(d[q1Variable]) - xScale(d[medianVariable]))
        .attr('y', -10)
        .attr('height', 20)
        .attr('width', xScale(d[q3Variable]) - xScale(d[q1Variable]))
        .style('fill', 'white')
        .style('stroke', 'black')
        .style('stroke-width', '3px')
				.on("mouseover", function(d) {
            div.transition()		
                .duration(200)		
                .style("opacity", 1);		
            div	.html('<strong>'+'median : '+'</strong>'+ d3.format(",.0f")(d.median) + "<br/>" +'<strong>'+'max : '+'</strong>'+d3.format(",.0f")(d.max) + "<br/>"  + '<strong>'+'min : '+'</strong>'+d3.format(",.0f")(d.min))	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");
						d3.select(this).style('fill', 'yellow')			
     				})
		.on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);
				d3.select(this).style('fill', 'white')	
        })
			d3.select(this)
        .append('line')
        .attr('x1', 0)
        .attr('x2', 0)
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'darkgray')
        .style('stroke-width', '4px')
		})
}
// for selected kmers
function draw_clicked_boxplot(clicked_kmers, clicked_colors, kmerValues){
	viewport_kmers = kmerValues
	d3.select('.viewport_selected').selectAll('*').remove()
	d3.csv('./data/boxplot_data.csv', function(data) {
		all_data = data
		clicked_data = []
		for (i=0;i<256;i++) {
			if(clicked_kmers.includes(data[i]['kmer']) ){
				clicked_data.push(data[i])
			}
		}
		data = clicked_data
		kmerValues = clicked_kmers
		var w = 350
		var h = 7500*clicked_data.length /256
		var margin = {
    top: 20,
    bottom: 20,
    left: 20,
    right: 30
  	}
	d3.select('.viewport_selected')
    .append('svg')
    .attr('height', h)
    .attr('width', w)
	var catVariable = 'order'
	var catValues = data.map(d => Number(d[catVariable]))
	var kmerValues = data.map(d => d['kmer'])
	const minVariable = 'min'
  const maxVariable = 'max'
  const medianVariable = 'median'
  const q1Variable = 'q1'
  const q3Variable = 'q3'
	var xScale = d3.scaleLinear()
			.domain([0,8000])
			.range([margin.left, w- margin.right-50])
	/*var yScale = d3.scaleLinear()
			.domain([
				Number(d3.max(data, d => d[catVariable])) + 1,
				Number(d3.min(data, d => d[catVariable])) - 1
			])
			.range([h - margin.bottom, margin.top])	
  */
	
	var yScale = d3.scalePoint()
			.domain(kmerValues)
			.range([margin.top,h - margin.bottom])
	/*var xAxis = d3.axisBottom()
								.scale(xScale)
								.ticks(10)
								.tickSize(-470) 
				
	d3.select('svg')
		.append('g')
		.attr('transform', 'translate(0,480)')
		.attr('id', 'xAxisG')
		.call(xAxis) */
	var yAxis = d3.axisRight()
								.scale(yScale)
								.tickSize(-470)
    						//.tickValues(catValues)
								//.tickValues(kmerValues)
								
	
	d3.select('.viewport_selected').select('svg')
		.append('g')
		.attr('transform', 'translate(300,0)')
		.attr('id', 'yAxisG')
		.call(yAxis)
	d3.select('.viewport_selected').select('svg')
		.selectAll('g.box')
		.data(data)
		.enter()
		.append('g')
		.attr('class', 'box')
		.attr(
			'transform', d => `translate(${xScale(d[medianVariable])},${yScale(d['kmer'])})`
		)
		
		.each(function(d, i) {
			d3.select(this)
        .append('rect')
        //.attr('class', 'cover')
        .attr('x', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y', -10)
        .attr('height', 20)
        .attr('width', 480)
        .style('fill', clicked_colors[i])
        .style('stroke', 'none')
        .style('stroke-width', '1px')
				.style('opacity', 0.3)
				.on("click", function(d) {				
							box_colors.push(d3.select(this).style("fill"))
							tsne_colors.splice(tsne_colors.indexOf(d3.select(this).style("fill")),1)
							
							index = kmer_list.indexOf(d.kmer)
							kmer_list.splice(index, 1)
							kmerValues = viewport_kmers
							kmerValues.push(d.kmer)
							draw_clicked_boxplot(kmer_list, tsne_colors, kmerValues)
							
							filtered_data = []
							for (i=0;i<all_data.length;i++) {
								if(kmerValues.includes(all_data[i]['kmer']) ){
								filtered_data.push(all_data[i])
								}
							}
							
							var form = document.getElementById("sort")
							var form_val;
							for(var i=0; i<form.length; i++){
      	  			if(form[i].checked){
      	    			form_val = form[i].id;
								}
							} 
							d3.select(".viewport").selectAll("*").remove()
							draw_boxplot(filtered_data, form_val)
					
						if (kmer_list.length == 1) {
								combine_1_kmer(kmer_list)
						} else if (kmer_list.length == 2) {
								combine_2_kmers(kmer_list)
						} else if (kmer_list.length == 3) {
								combine_3_kmers(kmer_list)
						} else if (kmer_list.length == 4) {
								combine_4_kmers(kmer_list)
						} else{
								d3.select('#tsne').selectAll('circle').remove()
						}
			
        })
			d3.select(this)
				.append('line')
				.attr('class', 'range')
				.attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', 0)
        .attr('y2', 0)
        .style('stroke', 'black')
        .style('stroke-width', '3px')
			d3.select(this)
        .append('line')
        .attr('class', 'max')
        .attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')			
			d3.select(this)
				.append('line')
        .attr('class', 'min')
        .attr('x1', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')
			d3.select(this)
        .append('rect')
        .attr('class', 'range')
        .attr('x', xScale(d[q1Variable]) - xScale(d[medianVariable]))
        .attr('y', -10)
        .attr('height', 20)
        .attr('width', xScale(d[q3Variable]) - xScale(d[q1Variable]))
        .style('fill', 'white')
        .style('stroke', 'black')
        .style('stroke-width', '3px')
				.on("mouseover", function(d) {
            div.transition()		
                .duration(200)		
                .style("opacity", 1);		
            div	.html('<strong>'+'median : '+'</strong>'+ d3.format(",.0f")(d.median) + "<br/>" +'<strong>'+'max : '+'</strong>'+d3.format(",.0f")(d.max) + "<br/>"  + '<strong>'+'min : '+'</strong>'+d3.format(",.0f")(d.min))	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");
						d3.select(this).style('fill', 'yellow')			
     				})
		.on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);
				d3.select(this).style('fill', 'white')	
        })
			d3.select(this)
        .append('line')
        .attr('x1', 0)
        .attr('x2', 0)
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'darkgray')
        .style('stroke-width', '4px')
		})
	})
}
// draw raw signals based on the data passed from add_signal
function draw_signal(data_click,data_hover, data_brush) {
					var data = data_hover.concat(data_click).concat(data_brush)
					
					var m = [80, 80, 80, 80]; // margins
        	var w = 700 - m[1] - m[3]; // width
        	var h = 300 - m[0] - m[2]; // height
        	 
        	
        	// X scale will fit all values from data[] within pixels 0-w
        	/*var x_max = 0;
        	for (var i = data_brush.length - 1; i >= 0; i--) {
        	    if (data_brush[i].length > x_max) x_max = data_brush[i].length;
        	};*/
        	var x = d3.scaleLinear()
						.domain([0, 260]) //set max value to fix the x-axis
						.range([0, w]);
        	// Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
        	
					var min = 999999;
					var max = 0;
					for (var i = data.length - 1; i >= 0; i--) {
        	    if(Math.max.apply(Math, data[i]) > max) max = Math.max.apply(Math, data[i])
							if(Math.min.apply(Math, data[i]) < min) min = Math.min.apply(Math, data[i])
        	};
					
        	var y = d3.scaleLinear().domain([min, max]).range([h, 0]); 
					
        	// automatically determining max range can work something like this
        	//var y = d3.scaleLinear().domain([0, d3.max(data_hover[0])]).range([h, 0]);
        	// create a line function that can convert data[] into x and y points
        	var line = d3.line()
        	// assign the X function to plot our line as we wish
        	.x(function(d, i) {
        	    
        	    // return the X coordinate where we want to plot this datapoint
        	    return x(i);
        	}).y(function(d) {
        	    
        	    // return the Y coordinate where we want to plot this datapoint
        	    return y(d);
        	})
        	// Add an SVG element with the desired dimensions and margin.
					d3.select(".raw_signal").selectAll('*').remove()
        	var graph = d3.select(".raw_signal")
						.append("svg:svg")
							.attr("width", w + m[1] + m[3])
							.attr("height", h + m[0] + m[2])
							.attr("id", "signal")
						.append("svg:g")
							.attr("transform", "translate(" + m[3] + "," + m[0] + ")")
						
        	// create xAxis
        	var xAxis = d3.axisBottom()
						.scale(x)
						.tickSize(-h)
						//.tickSubdivide(true);
        	// Add the x-axis.
        	graph.append("svg:g")
							.attr("class", "x axis")
							.attr("transform", "translate(0," + h + ")")
							.call(xAxis);
        	
					// add lines
        	// do this AFTER the axes above so that the line is above the tick-lines
					// signal plots for the clicked points
        	for (var i = data_click.length - 1; i >= 0; i--) {
        	    graph.append("svg:path")
									.attr("d", line(data_click[i]))
									.attr("class","line_click")
									.on("mouseover",function(d){d3.select(this).style("stroke-width",3)})
									.on("mouseout",function(d){d3.select(this).style("stroke-width",1)})
					};  
					
					// signal plot for the hovered point				
					for (var i = data_hover.length - 1; i >= 0; i--) {
							graph.append("svg:path")
									.attr("d", line(data_hover[i]))
									.attr("class","line_hover")
					};
					
					
					// signal plots for the brushed points
					
					graph.selectAll(".line")
    					.data(data_brush)
  					.enter().append("path")
    					.attr("d", line)
    					.attr("class", "line_brush")
							.attr("id", function(d,i){return "line_brush_"+d; })  ////
							.on("mouseover",function(d){d3.select(this).style("stroke-width",3)})
							.on("mouseout",function(d){d3.select(this).style("stroke-width",1)})
}
function putNodeOnTop(node) {
   var n = jQuery(node);
   n.parent().append(n.detach());
}
putNodeOnTop(d3.select(".line_hover").node());
function combine_1_kmer(kmer_list){
		kmer1 = kmer_list[0]
		
		folder1 = './data/distance_matrices/'+kmer1
		
		queue()
		.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer1 + '.csv')
		.await(combine_csv)
	function combine_csv(error, file1) {
		if(error) {console.log(error);}
		
		// Convert array of objects to array of arrays
		file1 = file1.map(obj => Object.values(obj));
		
		// call update_tsne
		update_tsne(file1, kmer_list)
	}
}
function combine_2_kmers(kmer_list){
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		folder1 = './data/distance_matrices/'+kmer1
		folder2 = './data/distance_matrices/'+kmer2
		queue()
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer2 + '.csv')
			.await(combine_csv)
	function combine_csv(error, file1, file2, file3, file4) {
		if(error) {console.log(error);}
		
		// Convert array of objects to array of arrays
		file1 = file1.map(obj => Object.values(obj));
		file2 = file2.map(obj => Object.values(obj));
		file3 = file3.map(obj => Object.values(obj));
		file4 = file4.map(obj => Object.values(obj));
		
		// column concat
		kmer1_row = file1.map((value,index) => { return value.concat(file2[index]) });
		kmer2_row = file3.map((value,index) => { return value.concat(file4[index]) });
		// row concat
		combined_matrix = kmer1_row.concat(kmer2_row)
		
		// call update_tsne
		update_tsne(combined_matrix, kmer_list)
	}
}
function combine_3_kmers(kmer_list){
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		folder1 = './data/distance_matrices/'+kmer1
		folder2 = './data/distance_matrices/'+kmer2
		folder3 = './data/distance_matrices/'+kmer3
		queue()
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer3 + '.csv')
			.await(combine_csv)
	function combine_csv(error, file1, file2, file3, file4, file5, file6, file7, file8, file9) {
		if(error) {console.log(error);}
		
		// Convert array of objects to array of arrays
		file1 = file1.map(obj => Object.values(obj));
		file2 = file2.map(obj => Object.values(obj));
		file3 = file3.map(obj => Object.values(obj));
		file4 = file4.map(obj => Object.values(obj));
		file5 = file5.map(obj => Object.values(obj));
		file6 = file6.map(obj => Object.values(obj));
		file7 = file7.map(obj => Object.values(obj));
		file8 = file8.map(obj => Object.values(obj));
		file9 = file9.map(obj => Object.values(obj));
		
		// column concat
		kmer1_row = file1.map((value,index) => { return value.concat(file2[index]).concat(file3[index]) });
		kmer2_row = file4.map((value,index) => { return value.concat(file5[index]).concat(file6[index]) });
		kmer3_row = file7.map((value,index) => { return value.concat(file8[index]).concat(file9[index]) });
		// row concat
		combined_matrix = kmer1_row.concat(kmer2_row).concat(kmer3_row)
				
		// call update_tsne
		update_tsne(combined_matrix, kmer_list)
	}
}
function combine_4_kmers(kmer_list){
		kmer1 = kmer_list[0]
		kmer2 = kmer_list[1]
		kmer3 = kmer_list[2]
		kmer4 = kmer_list[3]
		folder1 = './data/distance_matrices/'+kmer1
		folder2 = './data/distance_matrices/'+kmer2
		folder3 = './data/distance_matrices/'+kmer3
		folder4 = './data/distance_matrices/'+kmer4
		queue()
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder1 + '/' + kmer1 + '_' + kmer4 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder2 + '/' + kmer2 + '_' + kmer4 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder3 + '/' + kmer3 + '_' + kmer4 + '.csv')
			.defer(d3.csv, folder4 + '/' + kmer4 + '_' + kmer1 + '.csv')
			.defer(d3.csv, folder4 + '/' + kmer4 + '_' + kmer2 + '.csv')
			.defer(d3.csv, folder4 + '/' + kmer4 + '_' + kmer3 + '.csv')
			.defer(d3.csv, folder4 + '/' + kmer4 + '_' + kmer4 + '.csv')
			.await(combine_csv)
	function combine_csv(error, file1, file2, file3, file4, file5, file6, file7, file8, file9, file10, file11, file12, file13, file14, file15, file16) {
		if(error) {console.log(error);}
		
		// Convert array of objects to array of arrays
		file1 = file1.map(obj => Object.values(obj));
		file2 = file2.map(obj => Object.values(obj));
		file3 = file3.map(obj => Object.values(obj));
		file4 = file4.map(obj => Object.values(obj));
		file5 = file5.map(obj => Object.values(obj));
		file6 = file6.map(obj => Object.values(obj));
		file7 = file7.map(obj => Object.values(obj));
		file8 = file8.map(obj => Object.values(obj));
		file9 = file9.map(obj => Object.values(obj));
		file10 = file10.map(obj => Object.values(obj));
		file11 = file11.map(obj => Object.values(obj));
		file12 = file12.map(obj => Object.values(obj));
		file13 = file13.map(obj => Object.values(obj));
		file14 = file14.map(obj => Object.values(obj));
		file15 = file15.map(obj => Object.values(obj));
		file16 = file16.map(obj => Object.values(obj));
		
		
		// column concat
		kmer1_row = file1.map((value,index) => { return value.concat(file2[index]).concat(file3[index]).concat(file4[index]) });
		kmer2_row = file5.map((value,index) => { return value.concat(file6[index]).concat(file7[index]).concat(file8[index]) });
		kmer3_row = file9.map((value,index) => { return value.concat(file10[index]).concat(file11[index]).concat(file12[index]) });
		kmer4_row = file13.map((value,index) => { return value.concat(file14[index]).concat(file15[index]).concat(file16[index]) });
		// row concat
		combined_matrix = kmer1_row.concat(kmer2_row).concat(kmer3_row).concat(kmer4_row)
				
		// call update_tsne
		update_tsne(combined_matrix, kmer_list)
	}
}
// get positions of the t-sne plot before passing it to draw_tsne
var update_tsne = function(data, kmer_list) {
	
			
			//for(i=0; i<data.columns.length;i++){data.forEach(function(d){ d[data.columns[i]] = +d[data.columns[i]]; });}
			var dists = data.map(obj => Object.values(obj));
			tsne.initDataDist(dists);
			for(var k = 0; k < 250; k++) {
  			tsne.step(); // every time you call this, solution gets better
			}
			var Y = tsne.getSolution(); 
			
			draw_tsne(Y, kmer_list)
	
}
</script>
</body>

</html>

